<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <link rel="stylesheet" href="./index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="./favicon-normal.png" id="favicon">
    <title>チャット</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
</head>

<body>
    <div id="js-modal" class="layer">
        <div class="modal">
            <div class="modal__inner">
                <div class="modal__content">
                    <h1>ログイン</h1>
                    <div class="login-input-dialog">
                        <div class="modal__items">
                            <div class="modal__item">
                                <a class="modal__item_text">ID</a>
                                <input type="text" id="login-id">
                            </div>
                            <div class="modal__item">
                                <a class="modal__item_text">認証鍵</a>
                                <input type="password" id="login-token">
                            </div>
                            <div class="modal__item">
                                <a class="modal__item_text">ニックネーム</a>
                                <input type="text" id="login-username">
                            </div>
                        </div>
                        <a class="login-error">未入力の項目があります。</a>
                    </div>
                    <div class="login-confirm-dialog">
                        <p>前回のログイン情報で続行しますか？</p>
                        <div class="modal__items">
                            <div class="modal__item">
                                <a class="modal__item_text">ID</a>
                                <a id="saved-login-id"></a>
                            </div>
                            <div class="modal__item">
                                <a class="modal__item_text">ニックネーム</a>
                                <a id="saved-login-username"></a>
                            </div>
                        </div>
                    </div>
                    <div class="button-grp">
                        <button id="run-logout">ログアウト</button>
                        <button id="run-login">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <main>
            <div class="left-area">
                <div class="users-area">
                    <div class="expand-button" id="users-expand">
                        <svg id="users-arrow-up" width="24px" height="24px" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M18.2929 15.2893C18.6834 14.8988 18.6834 14.2656 18.2929 13.8751L13.4007 8.98766C12.6195 8.20726 11.3537 8.20757 10.5729 8.98835L5.68257 13.8787C5.29205 14.2692 5.29205 14.9024 5.68257 15.2929C6.0731 15.6835 6.70626 15.6835 7.09679 15.2929L11.2824 11.1073C11.673 10.7168 12.3061 10.7168 12.6966 11.1073L16.8787 15.2893C17.2692 15.6798 17.9024 15.6798 18.2929 15.2893Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <svg id="users-arrow-down" style="display: none;" width="24px" height="24px" viewBox="0 0 24 24"
                            fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M5.70711 9.71069C5.31658 10.1012 5.31658 10.7344 5.70711 11.1249L10.5993 16.0123C11.3805 16.7927 12.6463 16.7924 13.4271 16.0117L18.3174 11.1213C18.708 10.7308 18.708 10.0976 18.3174 9.70708C17.9269 9.31655 17.2937 9.31655 16.9032 9.70708L12.7176 13.8927C12.3271 14.2833 11.6939 14.2832 11.3034 13.8927L7.12132 9.71069C6.7308 9.32016 6.09763 9.32016 5.70711 9.71069Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <a>ユーザー</a>
                    </div>
                    <div id="users-data">
                    </div>
                    <div class="option-area">
                        <div class="expand-button" id="option-expand">
                            <svg id="option-arrow-up" width="24px" height="24px" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                <g id="SVGRepo_iconCarrier">
                                    <path
                                        d="M18.2929 15.2893C18.6834 14.8988 18.6834 14.2656 18.2929 13.8751L13.4007 8.98766C12.6195 8.20726 11.3537 8.20757 10.5729 8.98835L5.68257 13.8787C5.29205 14.2692 5.29205 14.9024 5.68257 15.2929C6.0731 15.6835 6.70626 15.6835 7.09679 15.2929L11.2824 11.1073C11.673 10.7168 12.3061 10.7168 12.6966 11.1073L16.8787 15.2893C17.2692 15.6798 17.9024 15.6798 18.2929 15.2893Z"
                                        fill="#858585"></path>
                                </g>
                            </svg>
                            <svg id="option-arrow-down" style="display: none;" width="24px" height="24px" viewBox="0 0 24 24"
                                fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                <g id="SVGRepo_iconCarrier">
                                    <path
                                        d="M5.70711 9.71069C5.31658 10.1012 5.31658 10.7344 5.70711 11.1249L10.5993 16.0123C11.3805 16.7927 12.6463 16.7924 13.4271 16.0117L18.3174 11.1213C18.708 10.7308 18.708 10.0976 18.3174 9.70708C17.9269 9.31655 17.2937 9.31655 16.9032 9.70708L12.7176 13.8927C12.3271 14.2833 11.6939 14.2832 11.3034 13.8927L7.12132 9.71069C6.7308 9.32016 6.09763 9.32016 5.70711 9.71069Z"
                                        fill="#858585"></path>
                                </g>
                            </svg>
                            <a>オプション</a>
                        </div>
                        <div id="option-data">
                            <input id="highlight-mymessage" type="checkbox"><a>自分のメッセージをハイライト表示</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="message-area">
                <button id="message-stop" style="position: absolute; display: none;">受信を停止</button>
                <div id="message-data">
                </div>
            </div>
        </main>
        <footer class="input-area">
            <div>
                <input id="message-input" placeholder="メッセージを入力..." type="text">
                <button id="send">送信</button>
            </div>
        </footer>
    </div>
</body>
<script>
    var islogindata = false;
    var isloginactive = false;
    var id = '';
    var token = '';
    var username = '';
    var timerId = '';
    var oldjson_msg = {};
    var oldjson_users = {};
    var isactive = true;
    var users_expanded = true;
    var option_expanded = true;

    function getCookieArray() {
        var arr = new Array();
        if (document.cookie != '') {
            var tmp = document.cookie.split('; ');
            for (var i = 0; i < tmp.length; i++) {
                var data = tmp[i].split('=');
                arr[data[0]] = decodeURIComponent(data[1]);
            }
        }
        return arr;
    }

    function loadLoginInfo() {
        const arr = getCookieArray();
        if (arr['logininfo'] === undefined) {
            return false;
        } else {
            const logininfo = JSON.parse(arr['logininfo']);
            id = logininfo.id;
            token = logininfo.token;
            username = logininfo.username;

            $('#login-id').val(id);
            $('#login-token').val(token);
            $('#login-username').val(username);

            $('#saved-login-id').text(id);
            $('#saved-login-username').text(username);
            return true;
        }
    }

    function writeLoginInfo(_id, _token, _username) {
        const json = {
            'id': _id,
            'token': _token,
            'username': _username
        }

        document.cookie = 'logininfo=' + JSON.stringify(json) + ';max-age=31536000';
    }

    function isValidUrl(string) {
        try {
            new URL(string); return true;
        } catch (err) {
            return false;
        }
    }

    async function getMessage() {
        const gas = 'https://script.google.com/macros/s/AKfycbx5D_ZqWRNmhulnp7ZAHXZX8llFqunr5n03-hELS_umOWkLwri75mCvpT-Jtx43VwRM/exec';
        const count = 50;
        const param = new URLSearchParams({ id: id, token: token, count: count })
        const url = gas + '?' + param;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                if (_.isEqual(json, oldjson_msg)) {
                } else {
                    $('#message-data').empty();
                    for (const data of json) {
                        var classname = '';
                        var href = '';

                        if (isValidUrl(data.message)) {
                            classname = ' message-data-link';
                            href = 'href="' + data.message + '" target="_blank" rel="noopener noreferrer"';
                        }

                        if (data.username == username) {
                            classname += ' message-data-my';
                        }

                        $('#message-data').append(
                            '<div class="message-data-items">' +
                            //'<span class="message-data-item message-data-id">' + data.id + '</span>' +
                            '<span class="message-data-item message-data-timestamp">' + data.timestamp + '</span>' +
                            '<span class="message-data-item message-data-username">' + data.username + '</span>' +
                            '<a class="message-data-item message-data-message' + classname + '" ' + href + '>' + data.message + '</a>' +
                            '</div>'
                        );
                    }

                    if (!isactive) {
                        document.getElementById('favicon').href = './favicon-notify.png';
                        document.title = '新着メッセージ | チャット';
                    }

                    document.getElementById('message-data').scrollTo(0, document.getElementById('message-data').scrollHeight);
                    oldjson_msg = json;

                    console.log('[Information] Message has been updated.');
                }
            });
    }

    $('#run-login').on('click', function () {
        const _id = $('#login-id').val();
        const _token = $('#login-token').val();
        const _username = $('#login-username').val();

        if (!islogindata) {
            if (_id === '' || _token === '' || _username === '') {
                $('.login-error').eq(0).show();
                return;
            }

            writeLoginInfo(_id, _token, _username);
            loadLoginInfo();
        }

        $('#js-modal').fadeOut(140);
        $('.main').eq(0).show();

        sendOnlineStatus('online');

        isloginactive = true;

        getMessage();
        getOnlineStatus();

        timerId = setInterval(function () {
            getMessage();
        }, 2000);

        var id = setInterval(function () {
            getOnlineStatus();
        }, 12000)
    })

    $('#run-logout').on('click', function () {
        document.cookie = "logininfo=; max-age=0";
        location.reload();
    })

    $('#message-input').on('keydown', function (e) {
        if (e.keyCode === 13) {
            $('#send').click();
        }
    })

    $('#send').on('click', function () {
        const message = $('#message-input').val();

        if (message === '') {
            $('.input-area').eq(0).addClass('shake');
            $('#message-input').css('background', '#ffb5b5');
            setTimeout(function () {
                $('.input-area').eq(0).removeClass('shake');
                $('#message-input').css('background', '');
            }, 720);

            return;
        }
        const date = new Intl.DateTimeFormat("ja-jp", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        }).format(new Date());

        const url = 'https://script.google.com/macros/s/AKfycbx5D_ZqWRNmhulnp7ZAHXZX8llFqunr5n03-hELS_umOWkLwri75mCvpT-Jtx43VwRM/exec';
        const json = { id: id, token: token, timestamp: date, username: username, message: message };

        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };
        fetch(url, params);

        $('#message-input').val('');
    })

    $('#message-stop').on('click', function () {
        clearInterval(timerId);
    })

    document.onvisibilitychange = function () {
        if (isloginactive) {
            if (document.visibilityState === 'hidden') {
                isactive = false;
                sendOnlineStatus('offline');
            }
            else {
                isactive = true;
                sendOnlineStatus('online');
                document.getElementById('favicon').href = './favicon-normal.png';
                document.title = 'チャット';
            }

            setTimeout(function () {
                getOnlineStatus();
            }, 1500);
        }
    }

    function sendOnlineStatus(status) {
        const url = 'https://script.google.com/macros/s/AKfycbwnb9HadY-6snnlREyqIAAs82YBSjir6fk7bKK7qaEN2hD05uZpWoCaFXWtEoAjzbgP/exec';
        const json = { id: id, token: token, username: username, status: status };
        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };

        fetch(url, params);
    }

    function getOnlineStatus() {
        const gas = 'https://script.google.com/macros/s/AKfycbwnb9HadY-6snnlREyqIAAs82YBSjir6fk7bKK7qaEN2hD05uZpWoCaFXWtEoAjzbgP/exec';
        const json = { id: id, token: token };
        const query = new URLSearchParams(json);
        const url = gas + '?' + query;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                //if (_.isEqual(json, oldjson_users)) {
                //} else {
                //    oldjson_users = json;
                //}

                $('#users-data').empty();
                for (const data of json) {
                    const status = data.status;
                    var _username = data.username;
                    const latestonline = data.latestonline;

                    const now_date = new Intl.DateTimeFormat("ja-jp", {
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                    }).format(new Date());
                    const now_time = new Intl.DateTimeFormat("ja-jp", {
                        hour: "2-digit",
                        minute: "2-digit",
                    }).format(new Date());

                    var icon = '';
                    if (status == 'online') {
                        icon = 'circle-online';
                    } else if (status == 'offline') {
                        icon = 'circle-offline';
                    }

                    var latest = '';
                    if (status == 'online') {
                        latest = 'オンライン中';
                        if (_username == username) {
                            _username = _username + ' (自分)'
                        }
                    } else if (status == 'offline') {
                        if (_username == username) {
                            latest = 'オンライン中';
                            icon = 'circle-online';
                            _username = _username + ' (自分)'
                        } else {
                            var latest_date = new Intl.DateTimeFormat("ja-jp", {
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit",
                            }).format(new Date(latestonline));
                            var latest_time = new Intl.DateTimeFormat("ja-jp", {
                                hour: "2-digit",
                                minute: "2-digit",
                            }).format(new Date(latestonline));

                            if (latest_date != now_date) {
                                latest = 'オフライン'
                            } else {
                                var _time = timeMath.sub(now_time + ':00', latest_time + ':00');
                                const time = _time.split(':');
                                const h = time[0];
                                const m = time[1];
                                const s = time[2];

                                if (h == 0) {
                                    if (m.charAt(0) == '0') {
                                        if (m == '00') {
                                            latest = '1分前にオンライン';
                                        } else {
                                            latest = m.charAt(1) + '分前にオンライン';
                                        }
                                    } else {
                                        latest = m + '分前にオンライン';
                                    }
                                } else {
                                    latest = h + '時間前にオンライン';
                                }
                            }
                        }
                    }

                    $('#users-data').append(
                        '<div class="users-data-items">' +
                        '<div>' +
                        '<div class="' + icon + '"></div>' +
                        '<span>' + _username + '</span>' +
                        '</div>' +
                        '<a>' + latest + '</a>' +
                        '</div>'
                    );
                }

            })
    }

    var timeMath = {
        sum: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if ((!second && second !== 0)) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result += second;
                }
            }

            return this.toTimeFormat(result);
        },

        sub: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if (!second) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result -= second;
                }
            }

            return this.toTimeFormat(result);
        },

        multiply: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if (!second) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result *= second;
                }
            }

            return this.toTimeFormat(result);
        },

        division: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if (!second) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result /= second;
                }
            }

            return this.toTimeFormat(result);
        },

        toSecond: function (hour, minute, second) {
            if ((!hour && hour !== 0) || (!minute && minute !== 0) || (!second && second !== 0) ||
                hour === null || minute === null || second === null ||
                typeof hour === 'boolean' ||
                typeof minute === 'boolean' ||
                typeof second === 'boolean' ||
                typeof Number(hour) === 'NaN' ||
                typeof Number(minute) === 'NaN' ||
                typeof Number(second) === 'NaN') return;

            return (Number(hour) * 60 * 60) + (Number(minute) * 60) + Number(second);
        },

        toTimeFormat: function (fullSecond) {
            var hour, minute, second;

            if ((!fullSecond && fullSecond !== 0) || !String(fullSecond).match(/^[\-0-9][0-9]*?$/)) return;

            var paddingZero = function (n) {
                return (n < 10) ? '0' + n : n;
            };

            hour = Math.floor(Math.abs(fullSecond) / 3600);
            minute = Math.floor(Math.abs(fullSecond) % 3600 / 60);
            second = Math.floor(Math.abs(fullSecond) % 60);

            minute = paddingZero(minute);
            second = paddingZero(second);

            return ((fullSecond < 0) ? '-' : '') + hour + ':' + minute + ':' + second;
        }
    };

    $('#users-expand').on('click', function () {
        if (!users_expanded) {
            $('#users-data').slideDown('400ms', function () {
                $('#users-arrow-up').show();
                $('#users-arrow-down').hide();
            });
        }
        else {
            $('#users-data').slideUp('400ms', function () {
                $('#users-arrow-up').hide();
                $('#users-arrow-down').show();
            });
        }

        users_expanded = !users_expanded;
    })

    $('#option-expand').on('click', function () {
        if (!option_expanded) {
            $('#option-data').slideDown('400ms', function () {
                $('#option-arrow-up').show();
                $('#option-arrow-down').hide();
            });
        }
        else {
            $('#option-data').slideUp('400ms', function () {
                $('#option-arrow-up').hide();
                $('#option-arrow-down').show();
            });
        }

        option_expanded = !option_expanded;
    })

    $('#highlight-mymessage').on('click', function () {
        if ($('#highlight-mymessage').val()) {
            $('.message-data-my').each(function (elem) {
                elem.css('background', '#b3e6ff');
            })
        }
    })

    $(window).on('beforeunload', function () {
        sendOnlineStatus('offline');
    });

    $(function () {
        $('.main').eq(0).hide();

        islogindata = loadLoginInfo();
        if (islogindata) {
            $('.login-input-dialog').hide();
            $('.login-confirm-dialog').show();
            $('#run-logout').show();
        } else {
            $('.login-input-dialog').show();
            $('.login-confirm-dialog').hide();
            $('#run-logout').hide();
            console.log('[Information] No login information is available.')
        }
    })
</script>

</html>