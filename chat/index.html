<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <link rel="stylesheet" href="./index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="./favicon-normal.png">
    <title>チャット</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
</head>

<body>
    <div id="js-modal" class="layer">
        <div class="modal">
            <div class="modal__inner">
                <div class="modal__content">
                    <h1>ログイン</h1>
                    <div class="login-input-dialog">
                        <div class="modal__items">
                            <div class="modal__item">
                                <a class="modal__item_text">ID</a>
                                <input type="text" id="login-id">
                            </div>
                            <div class="modal__item">
                                <a class="modal__item_text">認証鍵</a>
                                <input type="password" id="login-token">
                            </div>
                            <div class="modal__item">
                                <a class="modal__item_text">ニックネーム</a>
                                <input type="text" id="login-username">
                            </div>
                        </div>
                        <a class="login-error">未入力の項目があります。</a>
                    </div>
                    <div class="login-confirm-dialog">
                        <p>前回のログイン情報で続行しますか？</p>
                        <div class="modal__items">
                            <div class="modal__item">
                                <a class="modal__item_text">ID</a>
                                <a id="saved-login-id"></a>
                            </div>
                            <div class="modal__item">
                                <a class="modal__item_text">ニックネーム</a>
                                <a id="saved-login-username"></a>
                            </div>
                        </div>
                    </div>
                    <div class="button-grp">
                        <button id="run-logout">ログアウト</button>
                        <button id="run-login">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <button id="message-stop">受信を停止</button>
        <main class="message-area">
            <div id="message-data">
            </div>
        </main>
        <footer class="input-area">
            <div>
                <input id="message-input" placeholder="メッセージを入力..." type="text">
                <button id="send">送信</button>
            </div>
        </footer>
    </div>
</body>
<script>
    var islogin = false;
    var id = '';
    var token = '';
    var username = '';
    var timerId = '';
    var oldjson = {};
    var isactive = true;

    function getCookieArray() {
        var arr = new Array();
        if (document.cookie != '') {
            var tmp = document.cookie.split('; ');
            for (var i = 0; i < tmp.length; i++) {
                var data = tmp[i].split('=');
                arr[data[0]] = decodeURIComponent(data[1]);
            }
        }
        return arr;
    }

    function loadLoginInfo() {
        const arr = getCookieArray();
        if (arr['logininfo'] === undefined) {
            return false;
        } else {
            const logininfo = JSON.parse(arr['logininfo']);
            id = logininfo.id;
            token = logininfo.token;
            username = logininfo.username;

            $('#login-id').val(id);
            $('#login-token').val(token);
            $('#login-username').val(username);

            $('#saved-login-id').text(id);
            $('#saved-login-username').text(username);
            return true;
        }
    }

    function writeLoginInfo(_id, _token, _username) {
        const json = {
            'id': _id,
            'token': _token,
            'username': _username
        }

        document.cookie = 'logininfo=' + JSON.stringify(json);
    }

    async function getMessage() {
        const gas = 'https://script.google.com/macros/s/AKfycbx5D_ZqWRNmhulnp7ZAHXZX8llFqunr5n03-hELS_umOWkLwri75mCvpT-Jtx43VwRM/exec';
        const count = 50;
        const param = new URLSearchParams({ id: id, token: token, count: count })
        const url = gas + '?' + param;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                if (_.isEqual(json, oldjson)) {
                } else {
                    $('#message-data').empty();
                    for (const data of json) {
                        $('#message-data').append(
                            '<div class="message-data-items">' +
                            //'<span class="message-data-item message-data-id">' + data.id + '</span>' +
                            '<span class="message-data-item message-data-timestamp">' + data.timestamp + '</span>' +
                            '<span class="message-data-item message-data-username">' + data.username + '</span>' +
                            '<span class="message-data-item message-data-message">' + data.message + '</span>' +
                            '</div>'
                        );
                    }

                    if (!isactive) {
                        document.title = '新着メッセージ | チャット';
                    }

                    document.getElementById('message-data').scrollTo(0, document.getElementById('message-data').scrollHeight);
                    oldjson = json;

                    console.log('[Information] Message has been updated.');
                }
            });
    }

    $('#run-login').on('click', function () {
        const _id = $('#login-id').val();
        const _token = $('#login-token').val();
        const _username = $('#login-username').val();

        if (!islogin) {
            if (_id === '' || _token === '' || _username === '') {
                $('.login-error').eq(0).show();
                return;
            }

            writeLoginInfo(_id, _token, _username);
        }

        $('#js-modal').fadeOut(140);
        $('.main').eq(0).show();

        sendOnlineStatus('online');

        id = _id;
        token = _token;
        username = _username;

        timerId = setInterval(function () {
            getMessage();
        }, 2000);
    })

    $('#run-logout').on('click', function () {
        document.cookie = "logininfo=; max-age=0";
        location.reload();
    })

    $('#message-input').on('keydown', function (e) {
        if (e.keyCode === 13) {
            $('#send').click();
        }
    })

    $('#send').on('click', function () {
        const message = $('#message-input').val();

        if (message === '') {
            $('.input-area').eq(0).addClass('shake');
            $('#message-input').css('background', '#ffb5b5');
            setTimeout(function () {
                $('.input-area').eq(0).removeClass('shake');
                $('#message-input').css('background', '');
            }, 720);

            return;
        }
        const date = new Intl.DateTimeFormat("ja-jp", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        }).format(new Date());

        const url = 'https://script.google.com/macros/s/AKfycbx5D_ZqWRNmhulnp7ZAHXZX8llFqunr5n03-hELS_umOWkLwri75mCvpT-Jtx43VwRM/exec';
        const json = { id: id, token: token, timestamp: date, username: username, message: message };

        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };
        fetch(url, params);

        $('#message-input').val('');
    })

    $('#message-stop').on('click', function () {
        clearInterval(timerId);
    })

    document.onvisibilitychange = function () {
        if (document.visibilityState === 'hidden') {
            isactive = false;
            sendOnlineStatus('offline');
        }
        else {
            isactive = true;
            sendOnlineStatus('online');
            document.title = 'チャット';
        }

        getOnlineStatus();
    }

    function sendOnlineStatus(status) {
        const url = 'https://script.google.com/macros/s/AKfycbwnb9HadY-6snnlREyqIAAs82YBSjir6fk7bKK7qaEN2hD05uZpWoCaFXWtEoAjzbgP/exec';
        const json = { id: id, token: token, username: username, status: status };
        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };

        fetch(url, params);
    }

    function getOnlineStatus() {
        const gas = 'https://script.google.com/macros/s/AKfycbwnb9HadY-6snnlREyqIAAs82YBSjir6fk7bKK7qaEN2hD05uZpWoCaFXWtEoAjzbgP/exec?';
        const json = { id: id, token: token };
        const query = new URLSearchParams(json);
        const url = gas + '?' + query;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                console.log(json);
            })
    }

    $(function () {
        $('.main').eq(0).hide();

        islogin = loadLoginInfo();
        if (islogin) {
            $('.login-input-dialog').hide();
            $('.login-confirm-dialog').show();
            $('#run-logout').show();
        } else {
            $('.login-input-dialog').show();
            $('.login-confirm-dialog').hide();
            $('#run-logout').hide();
            console.log('[Information] No login information is available.')
        }
    })
</script>

</html>