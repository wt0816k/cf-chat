<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <title>Chat</title>
</head>

<body>
    <div id="js-modal" class="layer">
        <div class="modal">
            <div class="modal__inner">
                <div class="modal__content">
                    <h1>ログイン</h1>
                    <div class="modal__items">
                        <div class="modal__item">
                            <a class="modal__item_text">ID</a>
                            <input type="text" id="login-id">
                        </div>
                        <div class="modal__item">
                            <a class="modal__item_text">認証鍵</a>
                            <input type="password" id="login-token">
                        </div>
                        <div class="modal__item">
                            <a class="modal__item_text">ニックネーム</a>
                            <input type="text" id="login-username">
                        </div>
                        <a class="login-error">未入力の項目があります。</a>
                    </div>
                    <button id="run-login">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <button id="message-update">更新</button>
        <main class="message-area">
            <div id="message-data">
            </div>
        </main>
        <footer class="input-area">
            <input id="message-input" placeholder="メッセージを入力..." type="text">
            <button id="send">送信</button>
        </footer>
    </div>
</body>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script>
    var id = '';
    var token = '';
    var username = '';

    function getCookieArray() {
        var arr = new Array();
        if (document.cookie != '') {
            var tmp = document.cookie.split('; ');
            for (var i = 0; i < tmp.length; i++) {
                var data = tmp[i].split('=');
                arr[data[0]] = decodeURIComponent(data[1]);
            }
        }
        return arr;
    }

    function loadLoginInfo() {
        const arr = getCookieArray();
        if (arr['logininfo'] === undefined) {
            return false;
        } else {
            const logininfo = JSON.parse(btoa(arr['logininfo']));
            id = logininfo.id;
            token = logininfo.token;
            username = logininfo.username;
            return true;
        }
    }

    function writeLoginInfo(_id, _token, _username) {
        const json = {
            'id': _id,
            'token': _token,
            'username': _username
        }

        document.cookie = 'logininfo=' + JSON.stringify(json);
    }

    async function getMessage() {
        const gas = 'https://script.google.com/macros/s/AKfycbx5D_ZqWRNmhulnp7ZAHXZX8llFqunr5n03-hELS_umOWkLwri75mCvpT-Jtx43VwRM/exec';
        const count = 20;
        const url = gas + '?id=' + id + '&token=' + token + '&count=' + count;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                for (const data of json) {
                    $('#message-data').append(
                        '<span class="message-data-text message-data-id">' + data.id + '</span>' +
                        '<span class="message-data-text message-data-timestamp">' + data.timestamp + '</span>' +
                        '<span class="message-data-text message-data-username">' + data.username + '</span>' +
                        '<span class="message-data-text message-data-message">' + data.message + '</span>'
                    );

                    console.log(json);
                    return json;
                }
            });
    }

    $('#run-login').on('click', function () {
        const _id = $('#login-id').val();
        const _token = $('#login-token').val();
        const _username = $('#login-username').val();

        if (_id === '' || _token === '' || _username === '') {
            $('.login-error').eq(0).show();
            return;
        }

        $('#js-modal').fadeOut(140);
        $('.main').eq(0).show();

        id = _id;
        token = _token;
        username = _username;

        getMessage();
    })

    $('#send').on('click', function () {

    })

    $('#message-update').on('click', function () {
        getMessage();
    })

    $(function () {
        $('.main').eq(0).hide();

        if (loadLoginInfo()) {
            getMessage();
        } else {
            console.log('[Infomation] No login information is available.')
        }
    })
</script>

</html>