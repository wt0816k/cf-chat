<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <link rel="stylesheet" href="./css/colors.css">
    <link rel="stylesheet" href="./css/effect.css">
    <link rel="stylesheet" href="./css/footer.css">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/messages.css">
    <link rel="stylesheet" href="./css/modal.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&family=Noto+Sans+JP&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="./favicon-normal.png" id="favicon">
    <title>チャット</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
</head>

<body>
    <div id="js-modal" class="layer">
        <div class="modal">
            <div class="modal__inner">
                <div class="modal__content">
                    <div id="login-dialog">
                        <h1>ログイン</h1>
                        <div class="login-input-dialog">
                            <div class="modal__items">
                                <div class="modal__item">
                                    <a class="modal__item_text">ID</a>
                                    <input type="text" id="login-id">
                                </div>
                                <div class="modal__item">
                                    <a class="modal__item_text">認証鍵</a>
                                    <input type="password" id="login-token">
                                </div>
                                <div class="modal__item">
                                    <a class="modal__item_text">ニックネーム</a>
                                    <input type="text" id="login-username">
                                </div>
                            </div>
                            <a class="login-error">未入力の項目があります。</a>
                        </div>
                        <div class="login-confirm-dialog">
                            <p>前回のログイン情報で続行しますか？</p>
                            <div class="modal__items">
                                <div class="modal__item">
                                    <a class="modal__item_text">ID</a>
                                    <a id="saved-login-id"></a>
                                </div>
                                <div class="modal__item">
                                    <a class="modal__item_text">ニックネーム</a>
                                    <a id="saved-login-username"></a>
                                </div>
                            </div>
                        </div>
                        <div class="button-grp">
                            <button id="run-logout">ログアウト</button>
                            <button id="run-login">OK</button>
                        </div>
                    </div>
                    <div id="confirm-dialog">
                        <h1>確認</h1>
                        <p id="confirm-dialog-text"></p>
                        <div class="button-grp">
                            <button id="confirm-cancel">キャンセル</button>
                            <button id="confirm-ok">OK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="main">
        <main>
            <div class="left-area">
                <div class="groups-area">
                    <div class="expand-button" id="groups-expand">
                        <svg id="groups-arrow-up" width="24px" height="24px" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M18.2929 15.2893C18.6834 14.8988 18.6834 14.2656 18.2929 13.8751L13.4007 8.98766C12.6195 8.20726 11.3537 8.20757 10.5729 8.98835L5.68257 13.8787C5.29205 14.2692 5.29205 14.9024 5.68257 15.2929C6.0731 15.6835 6.70626 15.6835 7.09679 15.2929L11.2824 11.1073C11.673 10.7168 12.3061 10.7168 12.6966 11.1073L16.8787 15.2893C17.2692 15.6798 17.9024 15.6798 18.2929 15.2893Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <svg id="groups-arrow-down" style="display: none;" width="24px" height="24px"
                            viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M5.70711 9.71069C5.31658 10.1012 5.31658 10.7344 5.70711 11.1249L10.5993 16.0123C11.3805 16.7927 12.6463 16.7924 13.4271 16.0117L18.3174 11.1213C18.708 10.7308 18.708 10.0976 18.3174 9.70708C17.9269 9.31655 17.2937 9.31655 16.9032 9.70708L12.7176 13.8927C12.3271 14.2833 11.6939 14.2832 11.3034 13.8927L7.12132 9.71069C6.7308 9.32016 6.09763 9.32016 5.70711 9.71069Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <a>グループ</a>
                    </div>
                    <div id="groups-data">
                    </div>
                </div>
                <div class="users-area">
                    <div class="expand-button" id="users-expand">
                        <svg id="users-arrow-up" width="24px" height="24px" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M18.2929 15.2893C18.6834 14.8988 18.6834 14.2656 18.2929 13.8751L13.4007 8.98766C12.6195 8.20726 11.3537 8.20757 10.5729 8.98835L5.68257 13.8787C5.29205 14.2692 5.29205 14.9024 5.68257 15.2929C6.0731 15.6835 6.70626 15.6835 7.09679 15.2929L11.2824 11.1073C11.673 10.7168 12.3061 10.7168 12.6966 11.1073L16.8787 15.2893C17.2692 15.6798 17.9024 15.6798 18.2929 15.2893Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <svg id="users-arrow-down" style="display: none;" width="24px" height="24px" viewBox="0 0 24 24"
                            fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M5.70711 9.71069C5.31658 10.1012 5.31658 10.7344 5.70711 11.1249L10.5993 16.0123C11.3805 16.7927 12.6463 16.7924 13.4271 16.0117L18.3174 11.1213C18.708 10.7308 18.708 10.0976 18.3174 9.70708C17.9269 9.31655 17.2937 9.31655 16.9032 9.70708L12.7176 13.8927C12.3271 14.2833 11.6939 14.2832 11.3034 13.8927L7.12132 9.71069C6.7308 9.32016 6.09763 9.32016 5.70711 9.71069Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <a>ユーザー</a>
                    </div>
                    <div id="users-data">
                    </div>
                </div>
                <div class="option-area">
                    <div class="expand-button" id="option-expand">
                        <svg id="option-arrow-up" width="24px" height="24px" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M18.2929 15.2893C18.6834 14.8988 18.6834 14.2656 18.2929 13.8751L13.4007 8.98766C12.6195 8.20726 11.3537 8.20757 10.5729 8.98835L5.68257 13.8787C5.29205 14.2692 5.29205 14.9024 5.68257 15.2929C6.0731 15.6835 6.70626 15.6835 7.09679 15.2929L11.2824 11.1073C11.673 10.7168 12.3061 10.7168 12.6966 11.1073L16.8787 15.2893C17.2692 15.6798 17.9024 15.6798 18.2929 15.2893Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <svg id="option-arrow-down" style="display: none;" width="24px" height="24px"
                            viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M5.70711 9.71069C5.31658 10.1012 5.31658 10.7344 5.70711 11.1249L10.5993 16.0123C11.3805 16.7927 12.6463 16.7924 13.4271 16.0117L18.3174 11.1213C18.708 10.7308 18.708 10.0976 18.3174 9.70708C17.9269 9.31655 17.2937 9.31655 16.9032 9.70708L12.7176 13.8927C12.3271 14.2833 11.6939 14.2832 11.3034 13.8927L7.12132 9.71069C6.7308 9.32016 6.09763 9.32016 5.70711 9.71069Z"
                                    fill="#858585"></path>
                            </g>
                        </svg>
                        <a>オプション</a>
                    </div>
                    <div id="option-data">
                        <input id="highlight-mymessage" type="checkbox"><a>自分のメッセージをハイライト表示</a>
                    </div>
                </div>
            </div>
            <div class="message-area">
                <div id="message-data">
                </div>
            </div>
            <div id="information">
                <a></a>
            </div>
            <div id="preview-dialog">
                <img>
            </div>
        </main>
        <footer class="input-area">
            <div>
                <input id="message-input" placeholder="メッセージを入力..." type="text">
                <button id="send">送信</button>
            </div>
        </footer>
    </div>
</body>
<script type="module" src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
<script>
    //import { createPicker } from 'picmo';
    const Chat_Database = 'https://script.google.com/macros/s/AKfycbx5D_ZqWRNmhulnp7ZAHXZX8llFqunr5n03-hELS_umOWkLwri75mCvpT-Jtx43VwRM/exec';
    const Chat_OnlineStatus = 'https://script.google.com/macros/s/AKfycbwnb9HadY-6snnlREyqIAAs82YBSjir6fk7bKK7qaEN2hD05uZpWoCaFXWtEoAjzbgP/exec';

    var islogindata = false;
    var isloginactive = false;
    var id = '';
    var token = '';
    var username = '';
    var timerId = '';
    var oldjson_msg = {};
    var oldjson_users = {};
    var isactive = true;
    var users_expanded = true;
    var option_expanded = true;

    var _temp_id = '0';

    function getCookieArray() {
        var arr = new Array();
        if (document.cookie != '') {
            var tmp = document.cookie.split('; ');
            for (var i = 0; i < tmp.length; i++) {
                var data = tmp[i].split('=');
                arr[data[0]] = decodeURIComponent(data[1]);
            }
        }
        return arr;
    }

    function loadLoginInfo() {
        const arr = getCookieArray();
        if (arr['logininfo'] === undefined) {
            return false;
        } else {
            const logininfo = JSON.parse(arr['logininfo']);
            id = logininfo.id;
            token = logininfo.token;
            username = logininfo.username;

            $('#login-id').val(id);
            $('#login-token').val(token);
            $('#login-username').val(username);

            $('#saved-login-id').text(id);
            $('#saved-login-username').text(username);
            return true;
        }
    }

    function writeLoginInfo(_id, _token, _username) {
        const json = {
            'id': _id,
            'token': _token,
            'username': _username
        }

        document.cookie = 'logininfo=' + JSON.stringify(json) + ';max-age=31536000';
    }

    function isValidUrl(string) {
        try {
            new URL(string); return true;
        } catch (err) {
            return false;
        }
    }

    async function removeMessage(_id) {
        const url = Chat_Database;
        const json = {
            type: 'remove',
            dataid: id,
            token: token,
            id: _id
        };

        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };
        fetch(url, params);
    }

    async function getMessage() {
        const gas = Chat_Database;
        const count = 50;
        const param = new URLSearchParams({ dataid: id, token: token, count: count })
        const url = gas + '?' + param;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                if (_.isEqual(json, oldjson_msg)) {
                } else {
                    $('#message-data').empty();
                    for (const data of json) {
                        if (data.flags != 'removed') {
                            var classname = '';
                            var link = '';
                            var href = '';
                            var elem = '';
                            var buttons = '';

                            if (isValidUrl(data.message)) {
                                link = ' message-data-link';
                                href = 'href="' + data.message + '" target="_blank" rel="noopener noreferrer"';
                            }

                            if (data.username == username) {
                                classname += 'message-data-my';
                                buttons =
                                    `
                                <div class="message-data-button message-data-button-reply">
                                    <svg width="26px" height="26px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <polyline points="9 17 4 12 9 7"></polyline> <path d="M20 18v-2a4 4 0 00-4-4H4"></path> </g></svg>
                                </div>
                                <div class="message-data-button message-data-button-emoji">
                                    <svg style="margin-top: 2px;" width="22px" height="22px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8.5 11C9.32843 11 10 10.3284 10 9.5C10 8.67157 9.32843 8 8.5 8C7.67157 8 7 8.67157 7 9.5C7 10.3284 7.67157 11 8.5 11Z" fill="#0F0F0F"></path> <path d="M17 9.5C17 10.3284 16.3284 11 15.5 11C14.6716 11 14 10.3284 14 9.5C14 8.67157 14.6716 8 15.5 8C16.3284 8 17 8.67157 17 9.5Z" fill="#0F0F0F"></path> <path d="M8.88875 13.5414C8.63822 13.0559 8.0431 12.8607 7.55301 13.1058C7.05903 13.3528 6.8588 13.9535 7.10579 14.4474C7.18825 14.6118 7.29326 14.7659 7.40334 14.9127C7.58615 15.1565 7.8621 15.4704 8.25052 15.7811C9.04005 16.4127 10.2573 17.0002 12.0002 17.0002C13.7431 17.0002 14.9604 16.4127 15.7499 15.7811C16.1383 15.4704 16.4143 15.1565 16.5971 14.9127C16.7076 14.7654 16.8081 14.6113 16.8941 14.4485C17.1387 13.961 16.9352 13.3497 16.4474 13.1058C15.9573 12.8607 15.3622 13.0559 15.1117 13.5414C15.0979 13.5663 14.9097 13.892 14.5005 14.2194C14.0401 14.5877 13.2573 15.0002 12.0002 15.0002C10.7431 15.0002 9.96038 14.5877 9.49991 14.2194C9.09071 13.892 8.90255 13.5663 8.88875 13.5414Z" fill="#0F0F0F"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23ZM12 20.9932C7.03321 20.9932 3.00683 16.9668 3.00683 12C3.00683 7.03321 7.03321 3.00683 12 3.00683C16.9668 3.00683 20.9932 7.03321 20.9932 12C20.9932 16.9668 16.9668 20.9932 12 20.9932Z" fill="#0F0F0F"></path> </g></svg>
                                </div>
                                <div class="message-data-button message-data-button-remove">
                                    <svg width="26px" height="26px" fill="#cc0000" viewBox="-3.5 0 19 19" xmlns="http://www.w3.org/2000/svg" class="cf-icon-svg" stroke="#000000" stroke-width="0.00019"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M11.383 13.644A1.03 1.03 0 0 1 9.928 15.1L6 11.172 2.072 15.1a1.03 1.03 0 1 1-1.455-1.456l3.928-3.928L.617 5.79a1.03 1.03 0 1 1 1.455-1.456L6 8.261l3.928-3.928a1.03 1.03 0 0 1 1.455 1.456L7.455 9.716z"></path></g></svg>
                                </div>
                                `
                            } else {
                                buttons =
                                    `
                                <div class="message-data-button message-data-button-reply">
                                    <svg width="26px" height="26px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <polyline points="9 17 4 12 9 7"></polyline> <path d="M20 18v-2a4 4 0 00-4-4H4"></path> </g></svg>
                                </div>
                                <div class="message-data-button message-data-button-emoji">
                                    <svg style="margin-top: 2px;" width="22px" height="22px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8.5 11C9.32843 11 10 10.3284 10 9.5C10 8.67157 9.32843 8 8.5 8C7.67157 8 7 8.67157 7 9.5C7 10.3284 7.67157 11 8.5 11Z" fill="#0F0F0F"></path> <path d="M17 9.5C17 10.3284 16.3284 11 15.5 11C14.6716 11 14 10.3284 14 9.5C14 8.67157 14.6716 8 15.5 8C16.3284 8 17 8.67157 17 9.5Z" fill="#0F0F0F"></path> <path d="M8.88875 13.5414C8.63822 13.0559 8.0431 12.8607 7.55301 13.1058C7.05903 13.3528 6.8588 13.9535 7.10579 14.4474C7.18825 14.6118 7.29326 14.7659 7.40334 14.9127C7.58615 15.1565 7.8621 15.4704 8.25052 15.7811C9.04005 16.4127 10.2573 17.0002 12.0002 17.0002C13.7431 17.0002 14.9604 16.4127 15.7499 15.7811C16.1383 15.4704 16.4143 15.1565 16.5971 14.9127C16.7076 14.7654 16.8081 14.6113 16.8941 14.4485C17.1387 13.961 16.9352 13.3497 16.4474 13.1058C15.9573 12.8607 15.3622 13.0559 15.1117 13.5414C15.0979 13.5663 14.9097 13.892 14.5005 14.2194C14.0401 14.5877 13.2573 15.0002 12.0002 15.0002C10.7431 15.0002 9.96038 14.5877 9.49991 14.2194C9.09071 13.892 8.90255 13.5663 8.88875 13.5414Z" fill="#0F0F0F"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23ZM12 20.9932C7.03321 20.9932 3.00683 16.9668 3.00683 12C3.00683 7.03321 7.03321 3.00683 12 3.00683C16.9668 3.00683 20.9932 7.03321 20.9932 12C20.9932 16.9668 16.9668 20.9932 12 20.9932Z" fill="#0F0F0F"></path> </g></svg>
                                </div>
                                `
                            }

                            elem =
                                `
                            <div class="message-data-items ${classname}">
                                <span class="message-data-item message-data-timestamp">${data.timestamp}</span>
                                <span class="message-data-item message-data-username">${data.username}</span>
                                <a class="message-data-item message-data-message ${link}" ${href}>${data.message}</a>
                                <span class="message-data-item message-data-id">${data.id}</span>
                                <div class="message-data-buttons">
                                    ${buttons}
                                </div>
                            </div>
                            `;

                            $('#message-data').append(elem);
                        }
                    }

                    $('.message-data-buttons').hide();
                    $('.message-data-id').hide();
                    $('.message-data-items').hover(function () {
                        const index = $('.message-data-items').index(this);
                        $('.message-data-buttons').hide();
                        $('.message-data-id').hide();
                        $('.message-data-buttons').eq(index).show();
                        $('.message-data-id').eq(index).show();
                    }, function () {
                        $('.message-data-buttons').hide();
                        $('.message-data-id').hide();
                    });

                    $('.message-data-link').hover(function (e) {
                        const link = $(this).text();
                        const x = e.clientX;
                        const y = e.clientY;

                        $('#preview-dialog').css('top', x);
                        $('#preview-dialog').css('left', y);
    
                        $('#preview-dialog').fadeIn(100);
                        $('#preview-dialog img').attr('src', link);
                    }, function () {
                        setTimeout(function () {
                            $('#preview-dialog').fadeOut(100);
                        }, 1500);
                    });

                    $('.message-data-button-remove').on('click', function () {
                        const parent = $(this).parent();
                        _temp_id = $('.message-data-buttons').index(parent);
                        const mymessage = $('.message-data-message').eq(_temp_id).text();
                        $('#confirm-dialog-text').text('メッセージ: ' + mymessage + ' を送信取り消ししますか？')
                        $('#login-dialog').hide();
                        $('#confirm-dialog').show();
                        $('#js-modal').fadeIn(140);
                    });

                    $('.message-data-button-emoji').on('click', function () {
                        const rootElement = document.querySelector('.message-data-button-emoji');
                        const picker = createPicker({ rootElement });

                        picker.addEventListener('emoji:select', event => {
                            console.log('Emoji selected:', event.emoji);
                        });
                    })

                    $('#confirm-ok').on('click', function () {
                        const _id = $('.message-data-id').eq(_temp_id).text();
                        removeMessage(_id);
                        $('#js-modal').fadeOut(140);
                    });

                    $('#confirm-cancel').on('click', function () {
                        $('#js-modal').fadeOut(140);
                    });

                    if (!isactive) {
                        document.getElementById('favicon').href = './favicon-notify.png';
                        document.title = '新着メッセージ | チャット';
                    }

                    document.getElementById('message-data').scrollTo(0, document.getElementById('message-data').scrollHeight);
                    oldjson_msg = json;

                    console.log('[Information] Message has been updated.');
                }
            })
            .catch(function (error) {
                if (navigator.onLine) {
                    showInformation('エラー: "' + error + '"', '#a40000', 5000, null);
                }
            });
    }

    function showInformation(text, color, time, show) {
        if (time != 0) {
            $('#information').css('background', color);
            $('#information a').text(text);
            $('#information').animate({
                bottom: '68px'
            });
            setTimeout(function () {
                $('#information').animate({
                    bottom: '-140px'
                });
            }, time);
        } else {
            $('#information').css('background', color);
            $('#information a').text(text);
            if (show == true) {
                $('#information').animate({
                    bottom: '68px'
                });
            } else {
                $('#information').animate({
                    bottom: '-140px'
                });
            }
        }
    }

    $('#run-login').on('click', function () {
        const _id = $('#login-id').val();
        const _token = $('#login-token').val();
        const _username = $('#login-username').val();

        if (!islogindata) {
            if (_id === '' || _token === '' || _username === '') {
                $('.login-error').eq(0).show();
                return;
            }

            writeLoginInfo(_id, _token, _username);
            loadLoginInfo();
        }

        $('#option-expand').click();

        $('#js-modal').fadeOut(140);
        $('.main').eq(0).show();

        isloginactive = true;

        getMessage();
        getOnlineStatus();
        sendOnlineStatus('online');

        const tid_1 = setInterval(function () {
            getMessage();
        }, 2000);

        const tid_2 = setInterval(function () {
            getOnlineStatus();
        }, 10000)

        const tid_3 = setInterval(function () {
            if (isactive) {
                sendOnlineStatus('online');
            }
        }, 5000)

        timerId = tid_1;
    })

    $('#run-logout').on('click', function () {
        document.cookie = "logininfo=; max-age=0";
        location.reload();
    })

    $('#message-input').on('keydown', function (e) {
        if (e.keyCode === 13) {
            $('#send').click();
        }
    })

    $('#send').on('click', function () {
        const message = $('#message-input').val();
        sendMessage(message);
        $('#message-input').val('');
    })

    function sendMessage(message) {
        if (message == '') {
            $('.input-area').eq(0).addClass('shake');
            $('#message-input').css('background', '#ffb5b5');
            setTimeout(function () {
                $('.input-area').eq(0).removeClass('shake');
                $('#message-input').css('background', '');
            }, 720);

            return;
        }
        const date = new Intl.DateTimeFormat("ja-jp", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        }).format(new Date());

        const url = Chat_Database;
        const json = {
            type: 'add',
            dataid: id,
            token: token,
            timestamp: date,
            username: username,
            message: message
        };

        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };
        fetch(url, params);
    }

    document.onvisibilitychange = function () {
        if (isloginactive) {
            if (document.visibilityState == 'hidden') {
                isactive = false;
                sendOnlineStatus('offline');
            }
            else {
                isactive = true;
                sendOnlineStatus('online');
                document.getElementById('favicon').href = './favicon-normal.png';
                document.title = 'チャット';
            }

            setTimeout(function () {
                getOnlineStatus();
            }, 1500);
        }
    }

    function sendOnlineStatus(status) {
        const url = Chat_OnlineStatus;
        const json = {
            dataid: id,
            token: token,
            username: username,
            status: status
        };
        const params = {
            "method": "POST",
            "mode": "no-cors",
            "Content-Type": "application/x-www-form-urlencoded",
            "body": JSON.stringify(json)
        };

        fetch(url, params);
    }

    function getOnlineStatus() {
        const gas = Chat_OnlineStatus;
        const json = {
            dataid: id,
            token: token
        };
        const query = new URLSearchParams(json);
        const url = gas + '?' + query;

        fetch(url)
            .then(function (data) {
                if (data !== 'error') {
                    return data.json();
                } else {
                    console.log('[Infomation] HTTP request failed.')
                    return;
                }
            })
            .then(function (json) {
                $('#users-data').empty();
                for (const data of json) {
                    const status = data.status;
                    var _username = data.username;
                    const latestonline = data.latestonline;

                    const now_date = new Intl.DateTimeFormat("ja-jp", {
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                    }).format(new Date());
                    const now_time = new Intl.DateTimeFormat("ja-jp", {
                        hour: "2-digit",
                        minute: "2-digit",
                    }).format(new Date());

                    var icon = '';
                    if (status == 'online') {
                        icon = 'circle-online';
                    } else if (status == 'offline') {
                        icon = 'circle-offline';
                    }

                    var latest = '';
                    if (status == 'online') {
                        latest = 'オンライン中';
                        if (_username == username) {
                            _username = _username + ' (自分)'
                        }
                    } else if (status == 'offline') {
                        if (_username == username) {
                            latest = 'オンライン中';
                            icon = 'circle-online';
                            _username = _username + ' (自分)'
                        } else {
                            const latest_date = new Intl.DateTimeFormat("ja-jp", {
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit",
                            }).format(new Date(latestonline));
                            const latest_time = new Intl.DateTimeFormat("ja-jp", {
                                hour: "2-digit",
                                minute: "2-digit",
                            }).format(new Date(latestonline));

                            if (latest_date != now_date) {
                                latest = 'オフライン'
                            } else {
                                var _time = timeMath.sub(now_time + ':00', latest_time + ':00');
                                const time = _time.split(':');
                                const h = time[0];
                                const m = time[1];
                                const s = time[2];

                                if (h == 0) {
                                    if (m.charAt(0) == '0') {
                                        if (m == '00') {
                                            latest = '1分前にオンライン';
                                        } else {
                                            latest = m.charAt(1) + '分前にオンライン';
                                        }
                                    } else {
                                        latest = m + '分前にオンライン';
                                    }
                                } else {
                                    latest = h + '時間前にオンライン';
                                }
                            }
                        }
                    }

                    $('#users-data').append(
                        '<div class="users-data-items">' +
                        '<div>' +
                        '<div class="' + icon + '"></div>' +
                        '<span>' + _username + '</span>' +
                        '</div>' +
                        '<a>' + latest + '</a>' +
                        '</div>'
                    );
                }
            })
            .catch(function (error) {
                if (navigator.onLine) {
                    $('#information').css('background', '#a40000');
                    $('#information a').text('エラー: "' + error + '"');
                    $('#information').animate({
                        bottom: '68px'
                    });
                    setTimeout(function () {
                        $('#information').animate({
                            bottom: '-140px'
                        });
                    }, 5000);
                }
            });
    }

    var timeMath = {
        sum: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if ((!second && second !== 0)) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result += second;
                }
            }

            return this.toTimeFormat(result);
        },

        sub: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if (!second) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result -= second;
                }
            }

            return this.toTimeFormat(result);
        },

        multiply: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if (!second) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result *= second;
                }
            }

            return this.toTimeFormat(result);
        },

        division: function () {
            var result, times, second,
                len = arguments.length;

            if (len === 0) return;

            for (var i = 0; i < len; i++) {
                if (!arguments[i] || !arguments[i].match(/^[0-9]+:[0-9]{2}:[0-9]{2}$/)) continue;

                times = arguments[i].split(':');

                second = this.toSecond(times[0], times[1], times[2]);

                if (!second) continue;

                if (i === 0) {
                    result = second;
                } else {
                    result /= second;
                }
            }

            return this.toTimeFormat(result);
        },

        toSecond: function (hour, minute, second) {
            if ((!hour && hour !== 0) || (!minute && minute !== 0) || (!second && second !== 0) ||
                hour === null || minute === null || second === null ||
                typeof hour === 'boolean' ||
                typeof minute === 'boolean' ||
                typeof second === 'boolean' ||
                typeof Number(hour) === 'NaN' ||
                typeof Number(minute) === 'NaN' ||
                typeof Number(second) === 'NaN') return;

            return (Number(hour) * 60 * 60) + (Number(minute) * 60) + Number(second);
        },

        toTimeFormat: function (fullSecond) {
            var hour, minute, second;

            if ((!fullSecond && fullSecond !== 0) || !String(fullSecond).match(/^[\-0-9][0-9]*?$/)) return;

            var paddingZero = function (n) {
                return (n < 10) ? '0' + n : n;
            };

            hour = Math.floor(Math.abs(fullSecond) / 3600);
            minute = Math.floor(Math.abs(fullSecond) % 3600 / 60);
            second = Math.floor(Math.abs(fullSecond) % 60);

            minute = paddingZero(minute);
            second = paddingZero(second);

            return ((fullSecond < 0) ? '-' : '') + hour + ':' + minute + ':' + second;
        }
    };

    $('#users-expand').on('click', function () {
        if (!users_expanded) {
            $('#users-data').slideDown('400ms', function () {
                $('#users-arrow-up').show();
                $('#users-arrow-down').hide();
            });
        }
        else {
            $('#users-data').slideUp('400ms', function () {
                $('#users-arrow-up').hide();
                $('#users-arrow-down').show();
            });
        }

        users_expanded = !users_expanded;
    })

    $('#option-expand').on('click', function () {
        if (!option_expanded) {
            $('#option-data').slideDown('400ms', function () {
                $('#option-arrow-up').show();
                $('#option-arrow-down').hide();
            });
        }
        else {
            $('#option-data').slideUp('400ms', function () {
                $('#option-arrow-up').hide();
                $('#option-arrow-down').show();
            });
        }

        option_expanded = !option_expanded;
    })

    $('#highlight-mymessage').on('click', function () {
        if (document.getElementById('highlight-mymessage').checked) {
            document.documentElement.style.setProperty('--color-message-background-my', '#b3e6ff');
        } else {
            document.documentElement.style.setProperty('--color-message-background-my', '#ffffff');
        }
    })

    $(window).on('beforeunload', function () {
        sendOnlineStatus('offline');
    });

    $(window).on('online', function () {
        $('#information').animate({
            bottom: '-140px'
        });
    });

    $(window).on('offline', function () {
        $('#information').css('background', '#323232 ');
        $('#information a').text('現在、オフラインです。接続を待機しています...');
        $('#information').animate({
            bottom: '68px'
        });
    });

    $(function () {
        $('#confirm-dialog').hide();
        $('#login-dialog').show();
        $('.main').eq(0).hide();

        islogindata = loadLoginInfo();
        if (islogindata) {
            $('.login-input-dialog').hide();
            $('.login-confirm-dialog').show();
            $('#run-logout').show();
        } else {
            $('.login-input-dialog').show();
            $('.login-confirm-dialog').hide();
            $('#run-logout').hide();
            console.log('[Information] No login information is available.')
        }
    });
</script>

</html>